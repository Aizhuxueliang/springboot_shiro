<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<body>
<div id="app">
    <el-tabs :tab-position="tabPosition">
        <el-tab-pane label="用户设置">
            <el-row type="flex" justify="center">
                <el-col :span="18">
                    <el-button :plain="true" @click="queryUserListPage">分页查询用户</el-button>
                    <el-table
                            :data="tableData"
                            border
                            highlight-current-row
                            style="width: 100%">
                        <el-table-column
                                prop="id"
                                label="用户ID">
                        </el-table-column>
                        <el-table-column
                                prop="username"
                                label="用户姓名">
                        </el-table-column>
                        <el-table-column
                                label="操作">
                            <template slot-scope="scope">
                                <el-button
                                        type="text"
                                        icon="el-icon-setting"
                                        @click="handleEditUser(scope.$index, scope.row)">分配角色
                                </el-button>
                                <el-button
                                        type="text"
                                        icon="el-icon-delete"
                                        @click="handleDeleteUser(scope.$index, scope.row)">删除用户
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                    <el-pagination
                            layout="total, prev, pager, next, jumper"
                            :total="userRowCount"
                            :page-size="5"
                            :current-page.sync="currentPage"
                            @current-change="queryUserListPage"
                            :hide-on-single-page="hidePageFlag"
                            background>
                    </el-pagination>
                </el-col>
            </el-row>

            <el-dialog title="分配角色" :visible.sync="dialogEditUser" :before-close="handleClose">
                <el-transfer
                        v-model="transferValue"
                        :data="transferData"
                        :titles="['待分配角色', '已分配角色']">
                </el-transfer>
                <span slot="footer" class="dialog-footer">
			        <el-button @click="handleClose">取 消</el-button>
			        <el-button type="primary" @click="assignRoles">确 定</el-button>
		        </span>
            </el-dialog>

        </el-tab-pane>

        <el-tab-pane label="角色设置">

            <el-button
                    plain
                    @click="handleClose1">
                关闭
            </el-button>

        </el-tab-pane>

    </el-tabs>

</div>

</body>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue@2/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<!-- import Axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    new Vue({
        el: '#app',
        data: {
            // 穿梭框
            transferValue: [],
            transferData: [],
            // 表格及分页
            tableData: [],
            tabPosition: 'top',
            userRowCount: 0,
            currentPage: 0,
            hidePageFlag: true,
            // 角色弹框
            dialogEditUser: false,// 分配角色弹框
            // 用户信息
            allRoleList: [],
            id: 0,
            username: '',
            roleList: []
        },
        methods: {
            queryUserListPage() {
                <!--ELEMENT.Message('这是一条消息提示');-->
                axios.defaults.headers.post['Content-Type'] = 'application/json';
                axios({
                    method: 'post',
                    url: '/user/queryUserListPage',
                    data: JSON.stringify({
                        username: this.username,
                        reserve1: this.currentPage
                    })
                }).then(response => {
                    this.tableData = response.data.userListPage;
                    this.userRowCount = response.data.userRowCount;
                    if(this.userRowCount > 5) {
                        this.hidePageFlag = false;
                    } else {
                        this.hidePageFlag = true;
                    }
                    console.log(response.data);
                }).catch(error => {
                    console.log(error);
                });
            },
            handleEditUser(index, row) {
                axios.defaults.headers.post['Content-Type'] = 'application/json';
                axios({
                    method: 'post',
                    url: '/user/findRoleListByUserId',
                    data: JSON.stringify({
                        id: row.id
                    })
                }).then(response => {
                    console.log(response.data);
                    for(let item of response.data.allRoleList){
                        this.transferData.push({
                            key: item.id,
                            label: item.description
                        });
                    }
                    for(let item of response.data.beRoleList){
                        this.transferValue.push(item.id);
                    }
                    this.id = row.id;
                    this.username = row.username;
                    this.allRoleList = response.data.allRoleList;
                    this.dialogEditUser = true;
                }).catch(error => {
                    console.log(error);
                    ELEMENT.Message(error);
                });
            },
            assignRoles() {
                for(let item of this.allRoleList){
                    for(let i = 0, len = this.transferValue.length; i < len; i++ ){
                        if (this.transferValue[i] == item.id) {
                            this.roleList.push(item);
                        }
                    }
                }
                axios.defaults.headers.post['Content-Type'] = 'application/json';
                axios({
                    method: 'post',
                    url: '/user/updateUserRole',
                    data: JSON.stringify({
                        id: this.id,
                        username: this.username,
                        roleList: this.roleList
                    })
                }).then(response => {
                    if (response.data.removeUserRole >= 0 && response.data.addUserRole >= 0) {
                        this.dialogEditUser = false;
                        ELEMENT.Notification({
                            title: '更新成功',
                            message: '为用户'+this.username+'，分配角色成功！',
                            type: 'success',
                            position: 'top-right',
                            showClose: false,
                            offset: 100
                        });
                    }
                    this.id = 0;
                    this.username = '';
                    this.allRoleList = [];
                    this.roleList = [];
                    this.transferData = [];
                    this.transferValue = [];
                    console.log(response.data);
                }).catch(error => {
                    console.log(error);
                });

            },
            handleDeleteUser(index, row) {
                this.ruleForm = Object.assign({}, row, index); //这句是关键！！！
            },
            handleClose() {
                ELEMENT.Message({
                    message: '取消操作，系统不会保留任何更改',
                    type:'warning'
                });
                this.dialogEditUser = false;
                this.id = 0;
                this.username = '';
                this.allRoleList = [];
                this.roleList = [];
                this.transferData = [];
                this.transferValue = [];
            },
            handleClose1() {
                ELEMENT.MessageBox.confirm('此操作将永久删除该文件, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    ELEMENT.Message({ type: 'success', message: '删除成功!'});
                }).catch(() => {
                    ELEMENT.Message({ type: 'info', message: '已取消删除'});
                });
            }
        }

    })
</script>
<style>
    .el-pagination {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        height: 60px;
    }
    .el-transfer {
        display: flex;
        justify-content: center;
        align-items: center;
    }
</style>
</html>